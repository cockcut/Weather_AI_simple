<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ìƒí™œ ë¹„ì„œ - ë‚ ì”¨ ì•Œë¦¼</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter í°íŠ¸ ì‚¬ìš© */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            user-select: none; /* ì‚¬ìš©ì ì„ íƒ ë°©ì§€ */
            -webkit-tap-highlight-color: transparent; /* íƒ­ í•˜ì´ë¼ì´íŠ¸ ì œê±° */
        }
        .container {
            width: 95%;
            max-width: 1000px; /* 2ë‹¨ ë ˆì´ì•„ì›ƒì„ ìœ„í•´ ìµœëŒ€ ë„ˆë¹„ í™•ì¥ */
            min-height: 95vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding-top: 20px;
            padding-bottom: 20px;
        }
        .weather-card {
            cursor: pointer;
            transition: transform 0.1s ease-in-out, box-shadow 0.2s ease;
            height: 100%; /* ë¶€ëª¨ flex ë†’ì´ì— ë§ì¶¤ */
            min-height: 400px; /* ìµœì†Œ ë†’ì´ ì„¤ì • */
        }
        .weather-card:active {
            transform: scale(0.98);
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ */
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3b82f6; /* Blue-500 */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .location-item {
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .location-item:hover:not(.selected) {
            background-color: #eef2ff; /* indigo-50 */
        }
        .location-item.selected {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
        }
        .delete-btn {
            font-size: 0.8rem;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .location-item:hover .delete-btn {
            opacity: 1;
        }
        .location-item.selected .delete-btn {
            color: #fff;
            opacity: 0.8;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6">AI ë‚ ì”¨ ë¹„ì„œ</h1>

        <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ (ë°˜ì‘í˜• 2ë‹¨ ë ˆì´ì•„ì›ƒ) -->
        <div class="w-full flex flex-col md:flex-row md:space-x-5 mb-6">

            <!-- 1. ì €ì¥ëœ ìœ„ì¹˜ ëª©ë¡ (ì¦ê²¨ì°¾ê¸° ì„¹ì…˜) - md: 1/3 ë„ˆë¹„ -->
            <div class="md:w-1/3 mb-5 md:mb-0 p-4 bg-white rounded-xl shadow-lg border border-gray-200 h-fit">
                <h2 class="text-xl font-bold text-gray-700 mb-3 border-b pb-2 flex justify-between items-center">
                    â­ ì¦ê²¨ì°¾ëŠ” ìœ„ì¹˜ (ìµœëŒ€ 5ê°œ)
                </h2>
                <div id="saved-locations-list" class="flex flex-col">
                    <!-- ìœ„ì¹˜ í•­ëª©ì´ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
                </div>
                <p id="location-tip" class="text-sm text-gray-500 mt-3 p-2 text-center border-t pt-2">
                    ëª©ë¡ì—ì„œ ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ì—¬ ë‚ ì”¨ë¥¼ í™•ì¸í•˜ì„¸ìš”.
                </p>
            </div>

            <!-- 2. ë©”ì¸ ë‚ ì”¨ ì¹´ë“œ ì˜ì—­ - md: 2/3 ë„ˆë¹„ -->
            <div id="weather-card"
                 class="weather-card bg-white p-6 md:p-12 rounded-3xl shadow-2xl w-full flex flex-col justify-center items-center">

                <!-- ì´ˆê¸° ë¡œë”© ìƒíƒœ / ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
                <div id="status-display" class="space-y-6 text-center">
                    <div id="loader" class="spinner mx-auto hidden"></div>
                    <h2 id="main-message" class="text-3xl md:text-5xl font-bold text-gray-800 transition duration-300">
                        <span class="text-blue-600">ìœ„ì¹˜</span><br>ì •ë³´ í™•ì¸ ì¤‘...
                    </h2>
                    <p id="sub-message" class="text-lg md:text-2xl text-gray-500 mt-4">
                        ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.
                    </p>
                </div>

                <!-- ë‚ ì”¨ ê²°ê³¼ í‘œì‹œ ì˜ì—­ (ìˆ¨ê²¨ì ¸ ìˆë‹¤ê°€ ë°ì´í„° ë¡œë“œ í›„ í‘œì‹œ) -->
                <div id="weather-display" class="hidden space-y-4 text-center">
                    <p id="location-display" class="text-2xl md:text-4xl font-semibold text-gray-600">ìœ„ì¹˜</p>
                    <div class="flex items-center justify-center space-x-4">
                        <span id="icon-display" class="text-7xl md:text-9xl">â˜€ï¸</span>
                        <span id="temp-display" class="text-8xl md:text-[120px] font-bold text-blue-700">--Â°C</span>
                    </div>
                    <p id="desc-display" class="text-2xl md:text-4xl font-medium text-gray-700">ë‚ ì”¨ ìš”ì•½</p>
                    <button id="speak-button"
                            class="mt-6 px-6 py-3 bg-green-500 text-white text-xl font-bold rounded-xl hover:bg-green-600 shadow-lg transition duration-200 transform active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9.053 9.053 0 0 1 0 12.728l-5.657-5.657a4.526 4.526 0 0 0-6.386 0l-5.657 5.657a9.053 9.053 0 0 1 0-12.728l5.657 5.657a4.526 4.526 0 0 0 6.386 0l5.657-5.657Z" />
                        </svg>
                        ë‚ ì”¨ ë¸Œë¦¬í•‘ (í„°ì¹˜)
                    </button>
                </div>

                <!-- ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
                <p id="error-message" class="hidden text-lg md:text-xl text-red-500 mt-4"></p>

            </div>
        </div>
        
        <!-- ìˆ˜ë™ ìœ„ì¹˜ ì…ë ¥ ë° ì €ì¥ í¼ -->
        <div id="manual-input-section" class="w-full max-w-4xl p-5 bg-white rounded-xl shadow-lg border border-gray-200">
            <h2 class="text-xl font-bold text-gray-700 mb-3 border-b pb-2">ğŸ“ ìƒˆ ìœ„ì¹˜ (ì¢Œí‘œ) ì¶”ê°€</h2>
            <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-4 mb-3">
                <input type="text" id="manual-name" placeholder="ìœ„ì¹˜ ì´ë¦„ (ì˜ˆ: ì§‘, ì‚¬ë¬´ì‹¤)"
                       class="flex-1 p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <input type="number" step="any" id="manual-lat" placeholder="ìœ„ë„ (Latitude)"
                       class="flex-1 p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <input type="number" step="any" id="manual-lon" placeholder="ê²½ë„ (Longitude)"
                       class="flex-1 p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="flex justify-end space-x-4">
                <button id="add-location-button"
                        class="bg-blue-500 text-white p-3 rounded-lg font-bold hover:bg-blue-600 transition duration-200 shadow-md transform active:scale-95">
                    ìœ„ì¹˜ ëª©ë¡ì— ì¶”ê°€
                </button>
                <button id="clear-all-button"
                        class="bg-red-500 text-white p-3 rounded-lg font-bold hover:bg-red-600 transition duration-200 shadow-md transform active:scale-95">
                    ì „ì²´ ì´ˆê¸°í™”
                </button>
            </div>
            <p id="manual-input-tip" class="text-sm text-gray-500 mt-2">ì´ë¦„ê³¼ ì¢Œí‘œë¥¼ ëª¨ë‘ ì…ë ¥í•˜ê³  'ìœ„ì¹˜ ëª©ë¡ì— ì¶”ê°€' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¦ê²¨ì°¾ê¸°ì— ë“±ë¡í•˜ì„¸ìš”.</p>
        </div>

    </div>

    <script>
        // API í‚¤ëŠ” ë³´ì•ˆìƒì˜ ì´ìœ ë¡œ í¬í•¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì‚¬ìš©ìë‹˜ì˜ OpenWeatherMap ë˜ëŠ” ë‹¤ë¥¸ API í‚¤ë¡œ êµì²´í•´ì•¼ í•©ë‹ˆë‹¤.
        // **** ì—¬ê¸°ì— ë°œê¸‰ë°›ì€ API í‚¤ë¥¼ ì •í™•í•˜ê²Œ ì…ë ¥í•˜ì„¸ìš”! ****
        const WEATHER_API_KEY = "ì—¬ê¸°ì— ë°œê¸‰ë°›ì€ API í‚¤ë¥¼ ì •í™•í•˜ê²Œ ì…ë ¥"; // <--- ì´ ë¶€ë¶„ì„ ìˆ˜ì •í•˜ì„¸ìš”
        const API_URL = "https://api.openweathermap.org/data/2.5/weather";

        // ê¸°ë³¸ê°’ ì„¤ì • (ì„œìš¸ ì‹œì²­)
        const DEFAULT_LOCATION = { id: 'default', name: "ì„œìš¸ (ê¸°ë³¸ ìœ„ì¹˜)", lat: 37.5665, lon: 126.9780 };
        // GPS ìœ„ì¹˜ë¥¼ ìœ„í•œ íŠ¹ë³„ ID
        const GPS_LOCATION_ID = 'gps'; 

        const MAX_LOCATIONS = 5; // ìµœëŒ€ ì €ì¥ ê°€ëŠ¥ ìœ„ì¹˜ ìˆ˜ ì •ì˜

        let userLatitude = null;
        let userLongitude = null;
        let weatherData = null; // ë‚ ì”¨ ë°ì´í„°ë¥¼ ì €ì¥í•  ë³€ìˆ˜
        let savedLocations = []; // ì €ì¥ëœ ëª¨ë“  ìœ„ì¹˜ ëª©ë¡ (ìˆ˜ë™ ì¶”ê°€ëœ ê²ƒë§Œ)
        let activeLocationId = null; // í˜„ì¬ ì„ íƒëœ ìœ„ì¹˜ì˜ ID

        // DOM ìš”ì†Œ ìºì‹œ
        const statusDisplay = document.getElementById('status-display');
        const weatherDisplay = document.getElementById('weather-display');
        const mainMessage = document.getElementById('main-message');
        const subMessage = document.getElementById('sub-message');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const locationDisplay = document.getElementById('location-display');
        const tempDisplay = document.getElementById('temp-display');
        const iconDisplay = document.getElementById('icon-display');
        const descDisplay = document.getElementById('desc-display');
        const weatherCard = document.getElementById('weather-card');
        const speakButton = document.getElementById('speak-button');
        const savedLocationsList = document.getElementById('saved-locations-list');
        
        // ìˆ˜ë™ ì…ë ¥ ê´€ë ¨ ìš”ì†Œ
        const manualNameInput = document.getElementById('manual-name');
        const manualLatInput = document.getElementById('manual-lat');
        const manualLonInput = document.getElementById('manual-lon');
        const addButton = document.getElementById('add-location-button');
        const clearAllButton = document.getElementById('clear-all-button');
        
        // =========================================================================
        // 1. ìœ„ì¹˜ ëª©ë¡ ê´€ë¦¬ (localStorage)
        // =========================================================================

        /**
         * localStorageì—ì„œ ì €ì¥ëœ ìœ„ì¹˜ ëª©ë¡ì„ ë¡œë“œí•©ë‹ˆë‹¤.
         */
        function loadSavedLocations() {
            const storedList = localStorage.getItem('savedLocations');
            if (storedList) {
                savedLocations = JSON.parse(storedList);
            } else {
                savedLocations = [];
            }
            // í™œì„±í™”ëœ ìœ„ì¹˜ IDê°€ ì—†ë‹¤ë©´ 'default' (ì„œìš¸ ê¸°ë³¸ê°’)ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
            activeLocationId = localStorage.getItem('activeLocationId') || DEFAULT_LOCATION.id;
        }

        /**
         * í˜„ì¬ ìœ„ì¹˜ ëª©ë¡ê³¼ í™œì„±í™” IDë¥¼ localStorageì— ì €ì¥í•©ë‹ˆë‹¤.
         */
        function saveLocationsToStorage() {
            localStorage.setItem('savedLocations', JSON.stringify(savedLocations));
            localStorage.setItem('activeLocationId', activeLocationId);
            renderSavedLocations();
        }

        /**
         * ìœ„ì¹˜ ëª©ë¡ UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function renderSavedLocations() {
            savedLocationsList.innerHTML = '';
            
            // 1. ì„œìš¸(ê¸°ë³¸) ìœ„ì¹˜ í•­ëª© ì¶”ê°€
            const defaultLocDiv = document.createElement('div');
            defaultLocDiv.textContent = `ğŸ™ï¸ ${DEFAULT_LOCATION.name}`;
            defaultLocDiv.className = 'location-item border border-gray-300';
            defaultLocDiv.onclick = () => selectLocation(DEFAULT_LOCATION.id);
            
            if (activeLocationId === DEFAULT_LOCATION.id) {
                defaultLocDiv.classList.add('selected');
                defaultLocDiv.textContent = `âœ… ${DEFAULT_LOCATION.name}`;
            } else {
                 defaultLocDiv.textContent = `ğŸ™ï¸ ${DEFAULT_LOCATION.name}`;
            }
            savedLocationsList.appendChild(defaultLocDiv);
            
            // 2. ì €ì¥ëœ ìˆ˜ë™ ìœ„ì¹˜ í•­ëª© ì¶”ê°€ (ì¦ê²¨ì°¾ê¸°)
            savedLocations.forEach(loc => {
                const div = document.createElement('div');
                div.id = `loc-${loc.id}`;
                div.className = 'location-item border border-gray-300';
                div.onclick = () => selectLocation(loc.id);

                const nameSpan = document.createElement('span');
                nameSpan.textContent = loc.name;
                
                // ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = `&times;`; // X ì•„ì´ì½˜
                deleteBtn.className = 'delete-btn text-red-400 font-bold ml-3 p-1 rounded-full hover:bg-red-500 hover:text-white transition';
                deleteBtn.title = 'ìœ„ì¹˜ ì‚­ì œ';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation(); // ë²„íŠ¼ í´ë¦­ ì‹œ ì„ íƒ ì´ë²¤íŠ¸ ë°©ì§€
                    removeLocation(loc.id);
                };
                
                div.appendChild(nameSpan);
                div.appendChild(deleteBtn);

                if (loc.id === activeLocationId) {
                    div.classList.add('selected');
                    nameSpan.textContent = `âœ… ${loc.name}`;
                }
                savedLocationsList.appendChild(div);
            });
            
            // 3. GPS ìœ„ì¹˜ í•­ëª© ì¶”ê°€ (ê°€ì¥ ë§ˆì§€ë§‰ ìˆ˜ë‹¨)
            const gpsLocDiv = document.createElement('div');
            gpsLocDiv.textContent = 'ğŸŒ í˜„ì¬ ìœ„ì¹˜ (GPS ì‹œë„)';
            gpsLocDiv.className = 'location-item border border-gray-300';
            gpsLocDiv.onclick = () => selectLocation(GPS_LOCATION_ID);
            
            if (activeLocationId === GPS_LOCATION_ID) {
                gpsLocDiv.classList.add('selected');
                gpsLocDiv.textContent = 'âœ… í˜„ì¬ ìœ„ì¹˜ (GPS ì‹œë„)';
            }
            savedLocationsList.appendChild(gpsLocDiv);

            
            // 5ê°œ ì œí•œ ì•Œë¦¼ ì—…ë°ì´íŠ¸
            if (savedLocations.length >= MAX_LOCATIONS) {
                document.getElementById('location-tip').textContent = `âš ï¸ ìµœëŒ€ ${MAX_LOCATIONS}ê°œì˜ ì¦ê²¨ì°¾ê¸°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                addButton.disabled = true;
                addButton.classList.replace('bg-blue-500', 'bg-gray-400');
            } else {
                document.getElementById('location-tip').textContent = `ìƒˆ ìœ„ì¹˜ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ëª©ë¡ì—ì„œ ì„ íƒí•˜ì„¸ìš”. (ìµœëŒ€ 5ê°œ ì €ì¥)`;
                addButton.disabled = false;
                addButton.classList.replace('bg-gray-400', 'bg-blue-500');
            }
        }
        
        /**
         * ìœ„ì¹˜ë¥¼ ëª©ë¡ì—ì„œ ì„ íƒí•˜ê³  ë‚ ì”¨ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
         */
        function selectLocation(id) {
            activeLocationId = id;
            saveLocationsToStorage(); // activeLocationId ê°±ì‹  ë° UI ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            initializeApp(); // ì„ íƒëœ ìœ„ì¹˜ë¡œ ì•± ì¬ì‹œì‘
            
            let messageName;
            if (id === GPS_LOCATION_ID) {
                messageName = 'í˜„ì¬ ìœ„ì¹˜ (GPS)';
            } else if (id === DEFAULT_LOCATION.id) {
                messageName = DEFAULT_LOCATION.name;
            } else {
                messageName = savedLocations.find(loc => loc.id === id)?.name || 'ì•Œ ìˆ˜ ì—†ìŒ';
            }
            showTemporaryError(`âœ… ìƒˆë¡œìš´ ìœ„ì¹˜ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤: ${messageName}`);
        }
        
        /**
         * ìœ„ì¹˜ë¥¼ ëª©ë¡ì—ì„œ ì‚­ì œí•©ë‹ˆë‹¤.
         */
        function removeLocation(idToRemove) {
            savedLocations = savedLocations.filter(loc => loc.id !== idToRemove);
            
            // ì‚­ì œëœ ìœ„ì¹˜ê°€ í™œì„±í™”ëœ ìœ„ì¹˜ì˜€ë‹¤ë©´ ì„œìš¸(ê¸°ë³¸)ìœ¼ë¡œ ì „í™˜
            if (activeLocationId === idToRemove) {
                activeLocationId = DEFAULT_LOCATION.id;
            }
            saveLocationsToStorage();
            initializeApp();
            showTemporaryError("âœ… ìœ„ì¹˜ê°€ ì¦ê²¨ì°¾ê¸° ëª©ë¡ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        /**
         * ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥ëœ ì¢Œí‘œë¥¼ ëª©ë¡ì— ì¶”ê°€í•©ë‹ˆë‹¤.
         */
        function handleAddLocation() {
            // 5ê°œ ì œí•œ ì²´í¬
            if (savedLocations.length >= MAX_LOCATIONS) {
                showTemporaryError(`âš ï¸ ì¦ê²¨ì°¾ê¸°ëŠ” ìµœëŒ€ ${MAX_LOCATIONS}ê°œê¹Œì§€ë§Œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¸°ì¡´ ìœ„ì¹˜ë¥¼ ì‚­ì œí•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.`);
                return;
            }
            
            const name = manualNameInput.value.trim();
            const lat = parseFloat(manualLatInput.value);
            const lon = parseFloat(manualLonInput.value);

            if (!name) {
                showTemporaryError("âš ï¸ ìœ„ì¹˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                showTemporaryError("âš ï¸ ìœ íš¨í•œ ìœ„ë„(-90 ~ 90)ì™€ ê²½ë„(-180 ~ 180)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            
            // ìƒˆë¡œìš´ ìœ„ì¹˜ ê°ì²´ ìƒì„±
            const newLocation = {
                id: Date.now().toString(), // ê³ ìœ  ID ë¶€ì—¬
                name: name,
                lat: lat,
                lon: lon
            };

            // ëª©ë¡ì— ì¶”ê°€í•˜ê³  í™œì„±í™”
            savedLocations.push(newLocation);
            activeLocationId = newLocation.id;
            
            saveLocationsToStorage();
            
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            manualNameInput.value = '';
            manualLatInput.value = '';
            manualLonInput.value = '';
            
            // ì €ì¥ í›„ ì•± ì¬ì´ˆê¸°í™”
            initializeApp();
            showTemporaryError(`âœ… "${newLocation.name}"ì´(ê°€) ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }
        
        /**
         * ëª¨ë“  ì €ì¥ëœ ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚­ì œí•˜ê³  ì„œìš¸(ê¸°ë³¸)ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤.
         */
        function handleClearAll() {
            localStorage.removeItem('savedLocations');
            activeLocationId = DEFAULT_LOCATION.id;
            saveLocationsToStorage();
            showTemporaryError("âœ… ëª¨ë“  ì¦ê²¨ì°¾ê¸° ìœ„ì¹˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ì„œìš¸(ê¸°ë³¸ ìœ„ì¹˜)ë¡œ ì „í™˜ë©ë‹ˆë‹¤.");
            initializeApp();
        }
        
        /**
         * í•˜ë‹¨ì— ì„ì‹œ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤. (alert ëŒ€ì²´)
         */
        function showTemporaryError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            // ê¸°ì¡´ì˜ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ì¦‰ì‹œ ìˆ¨ê¸°ì§€ ì•Šê³ , ìƒˆë¡œìš´ ë©”ì‹œì§€ê°€ ë“¤ì–´ì˜¤ë©´ ë®ì–´ì“°ë„ë¡ 5ì´ˆ í›„ì— ìˆ¨ê¹€
            setTimeout(() => {
                if(errorMessage.textContent === message) {
                    errorMessage.classList.add('hidden');
                }
            }, 5000);
        }

        // =========================================================================
        // 2. ë‚ ì”¨ ë° GPS ë¡œì§
        // =========================================================================
        
        /**
         * ë‚ ì”¨ ì½”ë“œì— ë”°ë¥¸ ì•„ì´ì½˜ ë° í•œêµ­ì–´ ì„¤ëª… ë§¤í•‘
         */
        function getWeatherDetails(id) {
            let icon = 'â“'; // ê¸°ë³¸ê°’
            let description = 'ì•Œ ìˆ˜ ì—†ìŒ';
            let category = 'etc'; // ë©˜íŠ¸ ìƒì„±ì„ ìœ„í•œ ì¹´í…Œê³ ë¦¬

            if (id >= 200 && id < 300) { icon = 'â›ˆï¸'; description = 'ì²œë‘¥ë²ˆê°œ'; category = 'thunder'; }
            else if (id >= 300 && id < 400) { icon = 'ğŸŒ§ï¸'; description = 'ì´ìŠ¬ë¹„'; category = 'rain'; }
            else if (id >= 500 && id < 600) { icon = 'â˜”'; description = 'ë¹„'; category = 'rain'; }
            else if (id >= 600 && id < 700) { icon = 'â„ï¸'; description = 'ëˆˆ'; category = 'snow'; }
            else if (id >= 700 && id < 800) { icon = 'ğŸŒ«ï¸'; description = 'ì•ˆê°œ/íë¦¼'; category = 'atmosphere'; }
            else if (id === 800) { icon = 'â˜€ï¸'; description = 'ë§‘ìŒ'; category = 'clear'; }
            else if (id === 801) { icon = 'ğŸŒ¤ï¸'; description = 'êµ¬ë¦„ ì¡°ê¸ˆ'; category = 'cloud'; }
            else if (id > 801) { icon = 'â˜ï¸'; description = 'êµ¬ë¦„ ë§ìŒ'; category = 'cloud'; }

            return { icon, description, category };
        }

        /**
         * ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. (ìœ„ì¹˜ ê¶Œí•œ í•„ìš”)
         */
        function getGeolocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        // userLatitude/Longitude ì—…ë°ì´íŠ¸ëŠ” ì—¬ê¸°ì„œ í•˜ì§€ ì•Šê³ ,
                        // í˜¸ì¶œë¶€ì—ì„œ ì²˜ë¦¬í•˜ì—¬ ìƒíƒœ ì¼ê´€ì„± ìœ ì§€
                        resolve({ lat: position.coords.latitude, lon: position.coords.longitude });
                    },
                    (error) => {
                        let msg = `GPS ì ‘ê·¼ ì‹¤íŒ¨: ${error.message}.`;
                        reject(msg);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            });
        }

        /**
         * OpenWeatherMap APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
         */
        async function fetchWeather(locationName) {
            if (!WEATHER_API_KEY || WEATHER_API_KEY === "ë°œê¸‰ë°›ì€í‚¤ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”") {
                throw new Error("API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. OpenWeatherMapì—ì„œ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            }
            if (!userLatitude || !userLongitude) {
                throw new Error("ìœ„ì¹˜ ì •ë³´ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }

            const url = `${API_URL}?lat=${userLatitude}&lon=${userLongitude}&appid=${WEATHER_API_KEY}&units=metric&lang=kr`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("ë‚ ì”¨ API ì‘ë‹µ ì˜¤ë¥˜ ìƒì„¸:", errorText);
                    throw new Error(`ë‚ ì”¨ API ì‘ë‹µ ì˜¤ë¥˜: ${response.status} (í‚¤ ë¬¸ì œ ë˜ëŠ” ì„œë²„ ì˜¤ë¥˜)`);
                }
                const data = await response.json();
                
                // í•„ìš”í•œ ë°ì´í„° ì¶”ì¶œ
                const temp = Math.round(data.main.temp);
                // APIì—ì„œ ê°€ì ¸ì˜¨ ì´ë¦„ì´ ìˆë‹¤ë©´ ê·¸ê±¸ ì‚¬ìš©í•˜ê±°ë‚˜, ì…ë ¥ë°›ì€ locationName ì‚¬ìš©
                const finalName = data.name || locationName; 
                
                const weatherId = data.weather[0].id;
                const { icon, description, category } = getWeatherDetails(weatherId);

                weatherData = { temp, name: finalName, description, icon, category };
                
                // í™”ë©´ ì—…ë°ì´íŠ¸
                locationDisplay.textContent = finalName;
                tempDisplay.textContent = `${temp}Â°C`;
                descDisplay.textContent = description;
                iconDisplay.textContent = icon;

            } catch (error) {
                console.error("ë‚ ì”¨ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:", error);
                throw new Error(`ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }

        /**
         * Text-to-Speech (TTS) APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë‚ ì”¨ ì •ë³´ë¥¼ ìŒì„±ìœ¼ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.
         */
        function speakWeather() {
            if (!weatherData) {
                showTemporaryError("ë‚ ì”¨ ì •ë³´ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                return;
            }

            const { temp, name, description, category } = weatherData;
            
            // ì‹œê°„ëŒ€ë³„ ë§ì¶¤ ì¸ì‚¬ë§
            const hour = new Date().getHours();
            let greeting;
            if (hour >= 5 && hour < 12) {
                greeting = "ì¢‹ì€ ì•„ì¹¨ì…ë‹ˆë‹¤! ";
            } else if (hour >= 12 && hour < 18) {
                greeting = "ì•ˆë…•í•˜ì„¸ìš”. ";
            } else if (hour >= 18 && hour < 22) {
                greeting = "ì €ë… ì‹œê°„ì…ë‹ˆë‹¤. ";
            } else {
                greeting = "ëŠ¦ì€ ì‹œê°„ì…ë‹ˆë‹¤. ";
            }

            // ë‚ ì”¨ ì¹´í…Œê³ ë¦¬ì— ë”°ë¥¸ ì¶”ê°€ ë©˜íŠ¸
            let advice = "";
            switch(category) {
                case 'rain':
                    advice = "ì™¸ì¶œ ì‹œ ìš°ì‚°ì„ ê¼­ ì±™ê¸°ì„¸ìš”. ";
                    break;
                case 'snow':
                    advice = "ê¸¸ì´ ë¯¸ë„ëŸ¬ìš¸ ìˆ˜ ìˆìœ¼ë‹ˆ ì¡°ì‹¬í•˜ì„¸ìš”. ";
                    break;
                case 'thunder':
                    advice = "ì²œë‘¥ë²ˆê°œê°€ ì˜ˆìƒë©ë‹ˆë‹¤. ì•ˆì „ì— ìœ ì˜í•˜ì„¸ìš”. ";
                    break;
                case 'clear':
                    advice = "í™”ì°½í•œ ë‚ ì”¨ë„¤ìš”. ê¸°ë¶„ ì¢‹ì€ í•˜ë£¨ ë³´ë‚´ì„¸ìš”! ";
                    break;
                case 'atmosphere':
                    advice = "ë¯¸ì„¸ë¨¼ì§€ë‚˜ ì•ˆê°œì— ì£¼ì˜í•˜ì„¸ìš”. ";
                    break;
                default:
                    advice = "";
            }


            // TTS ë©”ì‹œì§€ ìƒì„±
            const message = `${greeting}${name}ì˜ í˜„ì¬ ë‚ ì”¨ë¥¼ ì•Œë ¤ë“œë¦´ê²Œìš”. í˜„ì¬ ê¸°ì˜¨ì€ ${temp}ë„ì´ë©°, ë‚ ì”¨ëŠ” ${description}ì…ë‹ˆë‹¤. ${advice}`;

            // TTS ì‹¤í–‰
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(message);
                utterance.lang = 'ko-KR'; // í•œêµ­ì–´ ì„¤ì •
                utterance.rate = 1.0;     // ë§í•˜ëŠ” ì†ë„
                utterance.volume = 1.0;   // ë³¼ë¥¨

                // ì´ë¯¸ ë§í•˜ëŠ” ì¤‘ì´ë¼ë©´ ì¤‘ì§€í•˜ê³  ìƒˆë¡œ ì‹œì‘
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                }
                
                speechSynthesis.speak(utterance);
            } else {
                console.warn("ì´ ë¸Œë¼ìš°ì €ëŠ” TTSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                showTemporaryError("TTS(ìŒì„± ì•ˆë‚´)ê°€ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
            }
        }
        
        // =========================================================================
        // 3. ì•± ì´ˆê¸°í™” ë° ì‹œì‘
        // =========================================================================

        /**
         * ì•± ì´ˆê¸°í™” ë° ë°ì´í„° ë¡œë“œ
         */
        async function initializeApp() {
            // UI ì´ˆê¸°í™” ë° ë¡œë”© ì‹œì‘
            loader.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            mainMessage.classList.remove('text-red-500'); 
            weatherDisplay.classList.add('hidden');
            statusDisplay.classList.remove('hidden');
            
            // ìœ„ì¹˜ ë°ì´í„° ë¡œë“œ ë° UI ì—…ë°ì´íŠ¸
            loadSavedLocations();
            renderSavedLocations();

            let locationToFetch = null;
            let locationName = null;
            
            if (activeLocationId === DEFAULT_LOCATION.id) {
                // 1. ì´ˆê¸°/ê¸°ë³¸ ì„ íƒ: ì„œìš¸ (ê¸°ë³¸ê°’) ì‚¬ìš©
                locationToFetch = DEFAULT_LOCATION;
                locationName = DEFAULT_LOCATION.name;
                
            } else if (activeLocationId === GPS_LOCATION_ID) {
                // 2. ì‚¬ìš©ìê°€ GPSë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì„ íƒí•œ ê²½ìš°
                locationName = "í˜„ì¬ ìœ„ì¹˜";
                mainMessage.textContent = "í˜„ì¬ ìœ„ì¹˜ í™•ì¸ ì¤‘...";
                subMessage.textContent = "GPSë¥¼ í†µí•´ ìœ„ì¹˜ë¥¼ ì°¾ìŠµë‹ˆë‹¤. ê¶Œí•œ ìš”ì²­ì— ì‘ë‹µí•´ì£¼ì„¸ìš”.";
                
                try {
                    const pos = await getGeolocation();
                    locationToFetch = { lat: pos.lat, lon: pos.lon, name: "í˜„ì¬ ìœ„ì¹˜ (GPS)" };
                } catch(geoError) {
                    console.warn("Geolocation ì‹¤íŒ¨:", geoError);
                    
                    // GPS ì‹¤íŒ¨ ì‹œ ê°•ì œì ìœ¼ë¡œ ì„œìš¸(ê¸°ë³¸)ìœ¼ë¡œ ì „í™˜í•˜ê³  ì¬ì‹œì‘
                    activeLocationId = DEFAULT_LOCATION.id;
                    saveLocationsToStorage(); 
                    showTemporaryError(`âš ï¸ ${geoError}. ì„œìš¸(ê¸°ë³¸ ìœ„ì¹˜)ë¡œ ìë™ ì „í™˜ë©ë‹ˆë‹¤.`);
                    initializeApp(); // ê¸°ë³¸ ìœ„ì¹˜ë¡œ ì¬ì‹œì‘
                    return;
                }
                
            } else {
                // 3. ì¦ê²¨ì°¾ê¸° ëª©ë¡ì—ì„œ ì„ íƒëœ ê²½ìš°
                locationToFetch = savedLocations.find(loc => loc.id === activeLocationId);
                
                if (!locationToFetch) {
                     // activeLocationIdê°€ ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš° (ì˜ˆ: ì‚­ì œëœ ìœ„ì¹˜ê°€ activeì˜€ì„ ê²½ìš°)
                     activeLocationId = DEFAULT_LOCATION.id;
                     saveLocationsToStorage();
                     initializeApp(); // ì¬ê·€ í˜¸ì¶œë¡œ ê¸°ë³¸ ìœ„ì¹˜ ë¡œì§ ë‹¤ì‹œ ì‹¤í–‰
                     return;
                }
                locationName = locationToFetch.name;
            }
            
            // ê³µí†µ: ë‚ ì”¨ API í˜¸ì¶œì„ ìœ„í•´ userLatitude/Longitude ì„¤ì •
            userLatitude = locationToFetch.lat;
            userLongitude = locationToFetch.lon;

            // 4. ë‚ ì”¨ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹œë„
            try {
                mainMessage.textContent = `${locationName} ë‚ ì”¨ ë¡œë”© ì¤‘...`;
                await fetchWeather(locationName);

                // 5. ì„±ê³µ ì‹œ í™”ë©´ ì „í™˜ ë° ìŒì„± ë¸Œë¦¬í•‘
                statusDisplay.classList.add('hidden');
                weatherDisplay.classList.remove('hidden');
                speakWeather(); 

            } catch (error) {
                console.error("ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
                
                // ì—ëŸ¬ ë°œìƒ ì‹œ UI ì—…ë°ì´íŠ¸
                loader.classList.add('hidden');
                statusDisplay.classList.remove('hidden');
                weatherDisplay.classList.add('hidden');
                
                mainMessage.textContent = "ì˜¤ë¥˜ ë°œìƒ";
                mainMessage.classList.add('text-red-500');
                
                const errorDetail = error.message.includes('API í‚¤') 
                                        ? "API í‚¤ë¥¼ ì„¤ì •í–ˆëŠ”ì§€, ê·¸ë¦¬ê³  í‚¤ê°€ í™œì„±í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”."
                                        : error.message;

                subMessage.textContent = errorDetail;
                showTemporaryError("âš ï¸ API í‚¤ë¥¼ í™•ì¸í•˜ê±°ë‚˜ ìˆ˜ë™ ìœ„ì¹˜ë¥¼ ì¶”ê°€í•´ ë³´ì„¸ìš”.");
                
            } finally {
                loader.classList.add('hidden');
            }
        }

        // ì•± ì‹œì‘
        window.onload = initializeApp;
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
        weatherCard.addEventListener('click', speakWeather);
        speakButton.addEventListener('click', (e) => {
            e.stopPropagation(); // ë²„íŠ¼ í´ë¦­ ì‹œ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ì¤‘ë³µ ë°©ì§€
            speakWeather();
        });
        
        addButton.addEventListener('click', handleAddLocation);
        clearAllButton.addEventListener('click', handleClearAll);

    </script>
</body>
</html>
